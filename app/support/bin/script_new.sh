#!/usr/bin/env bash
# ================================================================================
# PTEKWPDEV — a multi-project, bootstrap app for localized WordPress development
# github: https://github.com/ccnicholls99/ptekwpdev.git
# -------------------------------------------------------------------------------
# Script: app/support/bin/script_new.sh
#
# Synopsis:
#   Generate a new script shell for PTEKWPDEV
#
# Description:
#   Creates a new script with the canonical header template and optional includes.
#
# Notes:
#   All generated include blocks are wrapped in a DO-NOT-EDIT comment wrapper.
#
# ================================================================================

#!/usr/bin/env bash
set -Eeuo pipefail

# --- Error Handling ---------------------------------------------------------
COLOR_RED="\033[31m"
COLOR_RESET="\033[0m"
_ts() { date +"%Y-%m-%d %H:%M:%S"; }
err() { echo -e "${COLOR_RED}[$(_ts)] ERROR: $*${COLOR_RESET}" >&2; }

CALLER_PWD="$(pwd)"
trap 'err "Command failed (exit $?): $BASH_COMMAND"' ERR
trap 'cd "$CALLER_PWD" || true' EXIT
# ---------------------------------------------------------------------------

# Resolve APP_BASE from app/support/bin
APP_BASE="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../.." && pwd)"
SUPPORT_BASE="${APP_BASE}/app/support"
TEMPLATE_DIR="${SUPPORT_BASE}/templates"
HEADER_TEMPLATE="${TEMPLATE_DIR}/script_header.tpl"

# Flags
USE_ERR=0
USE_LOGGING=0
USE_UTILS=0
USE_APP_CONFIG=0
USE_PROJECT_CONFIG=0
USE_FORCE=0
USE_WHATIF=0

usage() {
    cat <<EOF
Usage: script_new.sh [options] <target-path>

Options:
  -e, --err             Include: source "\${APP_BASE}/lib/error.sh"
  -l, --logging         Include: source "\${APP_BASE}/lib/output.sh"
  -u, --utils           Include: source "\${APP_BASE}/lib/helpers.sh"
  -a, --app-config      Include: source "\${APP_BASE}/lib/app_config.sh"
  -p, --project-config  Include: source "\${APP_BASE}/lib/project_config.sh"
  -f, --force           Overwrite existing script
  -w, --what-f          Dry-run mode (preview actions, no writes)
  -h, --help            Show this help message

Example:
  script_new.sh -e -l -u ./bin/my_script.sh
  script_new.sh -e -l -u -w ./bin/my_script.sh
EOF
    exit 0
}

# --- Parse args -------------------------------------------------------------
ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -e|--err)             USE_ERR=1 ;;
        -l|--logging)         USE_LOGGING=1 ;;
        -u|--utils)           USE_UTILS=1 ;;
        -a|--app-config)      USE_APP_CONFIG=1 ;;
        -p|--project-config)  USE_PROJECT_CONFIG=1 ;;
        -f|--force)           USE_FORCE=1 ;;
        -w|--what-if)         USE_WHATIF=1 ;;
        -h|--help)            usage ;;
        -*)
            err "Unknown option: $1"
            exit 1
            ;;
        *)
            ARGS+=("$1")
            ;;
    esac
    shift
done

[[ ${#ARGS[@]} -eq 1 ]] || { err "Missing target path"; usage; }
TARGET="${ARGS[0]}"

# --- Create script ----------------------------------------------------------
if [[ $USE_WHATIF -eq 1 ]]; then
    echo "[WHAT-IF] Would create directory: $(dirname "$TARGET")"
else
    mkdir -p "$(dirname "$TARGET")"
fi

if [[ -e "$TARGET" ]]; then
    if [[ $USE_WHATIF -eq 1 ]]; then
        echo "[WHAT-IF] Target exists and would be overwritten: $TARGET"
    else
        if [[ $USE_FORCE -eq 1 ]]; then
            echo "Overwriting existing script: $TARGET"
            rm -f "$TARGET"
        else
            err "File already exists: $TARGET (use --force or --what-if)"
            exit 1
        fi
    fi
else
    if [[ $USE_WHATIF -eq 1 ]]; then
        echo "[WHAT-IF] Target does not exist and would be created: $TARGET"
    fi
fi

# Write canonical header
if [[ $USE_WHATIF -eq 1 ]]; then
    echo "[WHAT-IF] Would write header template to: $TARGET"
else
    cat "$HEADER_TEMPLATE" > "$TARGET"
fi

# --- Generated include block wrapper ----------------------------------------
if [[ $USE_WHATIF -eq 1 ]]; then
    echo "[WHAT-IF] Would append generated include block to: $TARGET"
else
    {
        echo ""
        echo "# ========================================================================"
        echo "# DO NOT EDIT THIS BLOCK — generated by script_new.sh"
        echo "# To modify includes, re-run script_new.sh with updated flags."
        echo "# ========================================================================"
        echo ""

        echo "# --- Optional Includes --------------------------------------------------"

        [[ $USE_ERR -eq 1 ]]            && cat "${TEMPLATE_DIR}/template.error.sh"
        [[ $USE_LOGGING -eq 1 ]]        && cat "${TEMPLATE_DIR}/template.output.sh"
        [[ $USE_UTILS -eq 1 ]]          && cat "${TEMPLATE_DIR}/template.helpers.sh"
        [[ $USE_APP_CONFIG -eq 1 ]]     && cat "${TEMPLATE_DIR}/template.app_config.sh"
        [[ $USE_PROJECT_CONFIG -eq 1 ]] && cat "${TEMPLATE_DIR}/template.prj_config.sh"

        echo "# ------------------------------------------------------------------------"
        echo ""
        echo "# ========================================================================"
        echo "# END GENERATED BLOCK"
        echo "# ========================================================================"
        echo ""
    } >> "$TARGET"
fi

if [[ $USE_WHATIF -eq 1 ]]; then
    echo "[WHAT-IF] Would set executable permissions on: $TARGET"
else
    chmod +x "$TARGET"
fi

if [[ $USE_WHATIF -eq 1 ]]; then
    echo "[WHAT-IF] Script generation completed (no changes made)."
else
    echo "Created script: $TARGET"
fi
